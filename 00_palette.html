<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Palette + CMD Manager</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 16px;
        }

        #paletteUI {
            margin-bottom: 12px;
        }

        .palette-item {
            display: grid;
            grid-template-columns: 50px 100px 1fr 60px;
            gap: 8px;
            align-items: start;
            margin: 8px 0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .palette-item input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            padding: 0;
        }

        .palette-item .hex {
            font-family: monospace;
            width: 90px;
            height: 32px;
        }

        .palette-item textarea {
            width: 100%;
            min-height: 3.6em;
            /* ÏïΩ 3Ï§Ñ */
            resize: vertical;
            font-family: monospace;
        }

        .palette-item button {
            cursor: pointer;
            height: 32px;
        }

        #controls {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        pre {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
        }
    </style>
</head>

<body>

    <h2>Palette + CMD Manager</h2>

    <div id="paletteUI"></div>

    <div id="controls">
        <button id="addColorBtn">+ Add Entry</button>
        <button id="saveJsonBtn">üíæ Save 00_palette.json</button>
        <button id="loadJsonBtn">üìÇ Load JSON</button>
        <input type="file" id="jsonFileInput" accept=".json" style="display:none" />
    </div>


    <h3>Debug: Palette JSON</h3>
    <pre id="debug"></pre>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let palette = [
                { color: '#000000', cmd: '' },
                { color: '#ffffff', cmd: '' },
                { color: '#ff0000', cmd: 'spawn_enemy();' },
                { color: '#00ff00', cmd: 'heal_player(10);' },
                { color: '#0000ff', cmd: '// water tile\nset_water(true);' },
            ];

            const paletteUI = document.getElementById('paletteUI');
            const addColorBtn = document.getElementById('addColorBtn');
            const saveJsonBtn = document.getElementById('saveJsonBtn');
            const loadJsonBtn = document.getElementById('loadJsonBtn');
            const jsonFileInput = document.getElementById('jsonFileInput');
            const debug = document.getElementById('debug');

            function renderPaletteUI() {
                paletteUI.innerHTML = '';

                palette.forEach((entry, index) => {
                    const row = document.createElement('div');
                    row.className = 'palette-item';

                    const colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.value = entry.color;
                    colorInput.addEventListener('input', () => {
                        entry.color = colorInput.value;
                        hexInput.value = entry.color;
                        updateDebug();
                    });

                    const hexInput = document.createElement('input');
                    hexInput.type = 'text';
                    hexInput.value = entry.color;
                    hexInput.className = 'hex';
                    hexInput.addEventListener('change', () => {
                        if (/^#[0-9a-fA-F]{6}$/.test(hexInput.value)) {
                            entry.color = hexInput.value;
                            colorInput.value = entry.color;
                            updateDebug();
                        } else {
                            hexInput.value = entry.color;
                        }
                    });

                    const cmdInput = document.createElement('textarea');
                    cmdInput.placeholder = 'Command / Script for this color...';
                    cmdInput.value = entry.cmd || '';
                    cmdInput.addEventListener('input', () => {
                        entry.cmd = cmdInput.value;
                        updateDebug();
                    });

                    const delBtn = document.createElement('button');
                    delBtn.textContent = '‚úñ';
                    delBtn.title = 'Delete';
                    delBtn.addEventListener('click', () => {
                        palette.splice(index, 1);
                        renderPaletteUI();
                        updateDebug();
                    });

                    row.appendChild(colorInput);
                    row.appendChild(hexInput);
                    row.appendChild(cmdInput);
                    row.appendChild(delBtn);

                    paletteUI.appendChild(row);
                });
            }

            addColorBtn.addEventListener('click', () => {
                palette.push({ color: '#888888', cmd: '' });
                renderPaletteUI();
                updateDebug();
            });

            // ===== Export =====
            saveJsonBtn.addEventListener('click', () => {
                const json = JSON.stringify(palette, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = '00_palette.json';
                document.body.appendChild(a);
                a.click();

                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // ===== Import =====
            loadJsonBtn.addEventListener('click', () => {
                jsonFileInput.value = ''; // Í∞ôÏùÄ ÌååÏùº Îã§Ïãú ÏÑ†ÌÉù Í∞ÄÎä•
                jsonFileInput.click();
            });

            jsonFileInput.addEventListener('change', () => {
                const file = jsonFileInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const parsed = JSON.parse(reader.result);

                        if (!Array.isArray(parsed)) {
                            throw new Error('JSON root is not an array');
                        }

                        // Íµ¨Ï°∞ Í≤ÄÏ¶ù + Ï†ïÍ∑úÌôî
                        const newPalette = parsed.map((item, i) => {
                            if (
                                !item ||
                                typeof item.color !== 'string' ||
                                !/^#[0-9a-fA-F]{6}$/.test(item.color)
                            ) {
                                throw new Error(`Invalid color at index ${i}`);
                            }

                            return {
                                color: item.color,
                                cmd: typeof item.cmd === 'string' ? item.cmd : ''
                            };
                        });

                        // ÍµêÏ≤¥
                        palette = newPalette;
                        renderPaletteUI();
                        updateDebug();

                        alert(`Loaded ${palette.length} palette entries.`);

                    } catch (err) {
                        console.error(err);
                        alert('Failed to load JSON:\n' + err.message);
                    }
                };

                reader.readAsText(file);
            });

            function updateDebug() {
                debug.textContent = JSON.stringify(palette, null, 2);
            }

            renderPaletteUI();
            updateDebug();

        });
    </script>
</body>

</html>