<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Aspect Canvas Image Tool</title>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: #eee;
        }

        button {
            margin: 4px;
        }

        canvas {
            background: #222;
            border: 1px solid #555;
            display: block;
            margin-top: 10px;
        }

        .panel {
            border: 1px solid #444;
            padding: 10px;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            height: 160px;
            background: #000;
            color: #0f0;
        }

        input[type=range] {
            width: 300px;
        }
    </style>
</head>

<body>

    <h2>Aspect Canvas Image Tool (Prototype)</h2>

    <div class="panel">
        <h3>1) Load Aspect Config JSON</h3>
        <input type="file" id="aspectJsonFile" accept=".json">
    </div>

    <div class="panel">
        <h3>2) Select Output Aspect</h3>
        <button onclick="selectAspect('16:9')">16:9</button>
        <button onclick="selectAspect('4:3')">4:3</button>
        <button onclick="selectAspect('1:1')">1:1</button>
        <button onclick="selectAspect('3:4')">3:4</button>
        <button onclick="selectAspect('9:16')">9:16</button>
        <div>Selected Aspect: <span id="selectedAspectLabel">16:9</span></div>
    </div>

    <div class="panel">
        <h3>3) Image Input + Scale</h3>
        <input type="file" id="imageInput" accept="image/*"><br><br>
        Scale:
        <input type="range" id="scaleSlider" min="0.2" max="3" step="0.01" value="1">
        <span id="scaleValue">1.00</span>
    </div>

    <div class="panel">
        <h3>Preview Canvas</h3>
        <canvas id="previewCanvas"></canvas>
        <button onclick="exportFinalImage()">Export Final Image</button>
        <canvas id="outputCanvas" style="display:none;"></canvas>
    </div>

    <script>
        const canvas = document.getElementById("previewCanvas");
        const ctx = canvas.getContext("2d");

        const outputCanvas = document.getElementById("outputCanvas");
        const outputCtx = outputCanvas.getContext("2d");

        const imageInput = document.getElementById("imageInput");
        const scaleSlider = document.getElementById("scaleSlider");
        const scaleValue = document.getElementById("scaleValue");
        const selectedAspectLabel = document.getElementById("selectedAspectLabel");

        let aspectConfig = {};
        let selectedAspect = "16:9";
        let currentImage = null;
        let userScale = 1.0;

        // --------- Utils ---------

        function getAspectCfg(aspect) {
            if (!Array.isArray(aspectConfig)) return null;
            return aspectConfig.find(a => a.ratio === aspect);
        }

        function calcCanvasSize(width, height, maxSize = 300) {
            const scale = Math.min(
                maxSize / width,
                maxSize / height,
                1
            );

            const canvasW = Math.round(width * scale);
            const canvasH = Math.round(height * scale);

            return { canvasW, canvasH };
        }



        function calcFitImage(imgW, imgH, canvasW, canvasH, scale = 1.0) {
            const imgRatio = imgW / imgH;
            const canvasRatio = canvasW / canvasH;

            let drawW, drawH;

            // ✅ COVER 로직 (Math.max 개념)
            if (imgRatio > canvasRatio) {
                // 이미지가 더 가로로 김 → 높이에 맞추고 좌우 crop
                drawH = canvasH;
                drawW = canvasH * imgRatio;
            } else {
                // 이미지가 더 세로로 김 → 너비에 맞추고 상하 crop
                drawW = canvasW;
                drawH = canvasW / imgRatio;
            }

            drawW *= scale;
            drawH *= scale;

            // 중심 기준 crop (offset이 음수가 될 수 있음)
            const drawX = (canvasW - drawW) / 2;
            const drawY = (canvasH - drawH) / 2;

            return { drawX, drawY, drawW, drawH };
        }

        const aspectJsonFile = document.getElementById("aspectJsonFile");

        aspectJsonFile.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                try {
                    aspectConfig = JSON.parse(reader.result);
                    alert("Aspect JSON loaded!");
                    setupCanvasSize();
                    redraw();
                } catch (err) {
                    alert("Aspect JSON parse error: " + err.message);
                }
            };
            reader.readAsText(file);
        });

        // --------- Aspect Selection ---------

        function selectAspect(aspect) {
            selectedAspect = aspect;
            selectedAspectLabel.textContent = aspect;
            setupCanvasSize();
            redraw();
        }

        function setupCanvasSize() {
            if (!selectedAspect) return;

            const cfg = getAspectCfg(selectedAspect);
            if (!cfg) {
                console.warn("Aspect not found:", selectedAspect);
                return;
            }

            const { canvasW, canvasH } = calcCanvasSize(cfg.width, cfg.height, 500);

            canvas.width = canvasW;
            canvas.height = canvasH;

            console.log("Canvas resized:", canvasW, canvasH);
        }


        // --------- Image Handling ---------

        imageInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;

            const img = new Image();
            img.onload = () => {
                currentImage = img;
                redraw();
            };
            img.src = URL.createObjectURL(file);
        });

        // --------- Scale ---------

        scaleSlider.addEventListener("input", e => {
            userScale = parseFloat(e.target.value);
            scaleValue.textContent = userScale.toFixed(2);
            redraw();
        });

        // --------- Draw ---------

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (!currentImage) return;

            const fit = calcFitImage(
                currentImage.width,
                currentImage.height,
                canvas.width,
                canvas.height,
                userScale
            );

            ctx.drawImage(
                currentImage,
                fit.drawX,
                fit.drawY,
                fit.drawW,
                fit.drawH
            );
        }

        function exportFinalImage() {
            if (!currentImage) {
                alert("No image loaded");
                return;
            }

            const cfg = getAspectCfg(selectedAspect);
            if (!cfg) {
                alert("No aspect config");
                return;
            }

            const outW = cfg.width;
            const outH = cfg.height;

            // Hidden output canvas 실제 해상도 설정
            outputCanvas.width = outW;
            outputCanvas.height = outH;

            outputCtx.clearRect(0, 0, outW, outH);

            // === 실제 해상도 기준으로 Keep Aspect + Center + Scale 계산 ===
            const fit = calcFitImage(
                currentImage.width,
                currentImage.height,
                outW,
                outH,
                userScale
            );

            outputCtx.drawImage(
                currentImage,
                fit.drawX,
                fit.drawY,
                fit.drawW,
                fit.drawH
            );

            // === 다운로드 ===
            const link = document.createElement("a");
            link.download = `output_${selectedAspect.replace(':', 'x')}.png`;
            link.href = outputCanvas.toDataURL("image/png");
            link.click();
        }


        // --------- Init ---------

        loadAspectJson();
        selectAspect("16:9");
    </script>

</body>

</html>